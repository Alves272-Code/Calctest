<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora Completa de Orçamento</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin:0; background: #f7f7f7; }
  header { background: #fff; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
  header img { max-height: 60px; }
  .container { max-width: 800px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.15); }
  h3 { margin-bottom: 10px; }
  .item { display: flex; gap: 10px; margin-bottom: 10px; }
  input, select { padding: 5px; flex:1; border:1px solid #ccc; border-radius:5px; }
  button { padding: 10px; margin: 5px 0; width: 100%; background: #0077b6; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-weight:bold; }
  button:hover { background: #005f86; }
  .resultado { margin-top: 20px; font-weight: bold; white-space: pre-line; background:#e0f7fa; padding:10px; border-radius:5px; }
  canvas { margin-top: 20px; }
  footer { background:#0077b6; color:white; text-align:center; padding:15px; margin-top:20px; border-radius:0 0 10px 10px; }
  footer .doar { margin-top:10px; }
</style>
</head>
<body>

<header>
  <img src="https://github.com/Alves272-Code/Calctest/blob/main/logo.png?raw=true" alt="Logo">
</header>

<div class="container" id="containerPDF">

  <h3 id="rendimentos">Rendimentos</h3>
  <div id="rendimentosContainer"></div>
  <button onclick="adicionarRendimento()">Adicionar Rendimento</button>

  <h3 id="despesas">Despesas</h3>
  <div id="despesasContainer"></div>
  <button onclick="adicionarDespesa()">Adicionar Despesa</button>

  <button onclick="calcular()">Calcular Orçamento</button>
  <button onclick="exportCSV()">Exportar CSV</button>
  <button onclick="exportPDF()">Exportar PDF</button>

  <div class="resultado" id="resultado"></div>

  <canvas id="grafico"></canvas>
</div>

<footer>
  <div class="doar">
    <p>Se esta calculadora te ajudou, apoie nosso desenvolvimento:</p>
    <a href="https://www.paypal.com/donate" target="_blank">
      <button>Doar</button>
    </a>
  </div>
  <p>Calculadora de Orçamento © 2025 | Desenvolvido para ajudar no planejamento financeiro</p>
</footer>

<script>
let rendimentosContainer = document.getElementById('rendimentosContainer');
let despesasContainer = document.getElementById('despesasContainer');
let grafico;

// Adicionar campos
function adicionarRendimento() {
  let div = document.createElement('div');
  div.classList.add('item');
  div.innerHTML = `
    <input type="text" placeholder="Descrição" class="descRend">
    <input type="number" placeholder="Valor" class="valorRend">
  `;
  rendimentosContainer.appendChild(div);
}

function adicionarDespesa() {
  let div = document.createElement('div');
  div.classList.add('item');
  div.innerHTML = `
    <input type="text" placeholder="Descrição" class="descDesp">
    <input type="number" placeholder="Valor" class="valorDesp">
    <select class="categoriaDesp">
      <option value="Fixas">Fixas</option>
      <option value="Variáveis">Variáveis</option>
      <option value="Alimentação">Alimentação</option>
      <option value="Lazer">Lazer</option>
    </select>
  `;
  despesasContainer.appendChild(div);
}

// Calcular orçamento
function calcular() {
  const descRends = document.querySelectorAll('.descRend');
  const valorRends = document.querySelectorAll('.valorRend');
  const descDesps = document.querySelectorAll('.descDesp');
  const valorDesps = document.querySelectorAll('.valorDesp');
  const catDesps = document.querySelectorAll('.categoriaDesp');

  let rendimentos = [];
  let despesas = [];

  for(let i=0;i<valorRends.length;i++){
    if(valorRends[i].value){
      rendimentos.push({desc: descRends[i].value || 'Rendimento', valor: parseFloat(valorRends[i].value)});
    }
  }
  for(let i=0;i<valorDesps.length;i++){
    if(valorDesps[i].value){
      despesas.push({desc: descDesps[i].value || 'Despesa', valor: parseFloat(valorDesps[i].value), categoria: catDesps[i].value});
    }
  }

  let totalRend = rendimentos.reduce((a,b)=>a+b.valor,0);
  let totalDesp = despesas.reduce((a,b)=>a+b.valor,0);
  let sobra = totalRend - totalDesp;

  // Resultado detalhado
  let resultadoText = `Total de Rendimentos: ${totalRend.toFixed(2)}€\nTotal de Despesas: ${totalDesp.toFixed(2)}€\nSobra: ${sobra.toFixed(2)}€\n\nDespesas por categoria:\n`;
  let categorias = {};
  despesas.forEach(d=>{
    categorias[d.categoria] = (categorias[d.categoria] || 0) + d.valor;
  });
  for(const cat in categorias){
    resultadoText += `${cat}: ${categorias[cat].toFixed(2)}€\n`;
  }
  document.getElementById('resultado').innerText = resultadoText;

  // Gráfico azul
  const labels = [...rendimentos.map(r=>r.desc), ...despesas.map(d=>d.desc)];
  const data = [...rendimentos.map(r=>r.valor), ...despesas.map(d=>d.valor)];
  const backgroundColors = [...rendimentos.map(r=>'#0077b6'), ...despesas.map(d=>'#00b4d8')];

  if(grafico) grafico.destroy();
  const ctx = document.getElementById('grafico').getContext('2d');
  grafico = new Chart(ctx, {
    type: 'pie',
    data: { labels: labels, datasets: [{ data: data, backgroundColor: backgroundColors }] },
    options: { responsive:true, plugins:{ legend:{ position:'bottom' } } }
  });
}

// Export CSV
function exportCSV() {
  let csv = 'Tipo;Descrição;Valor;Categoria\n';
  let totalRend = 0, totalDesp = 0;
  document.querySelectorAll('.descRend').forEach((d,i)=>{
    let v = document.querySelectorAll('.valorRend')[i].value;
    if(v){
      csv += `Rendimento;${d.value};${v};-\n`;
      totalRend += parseFloat(v);
    }
  });
  document.querySelectorAll('.descDesp').forEach((d,i)=>{
    let v = document.querySelectorAll('.valorDesp')[i].value;
    let c = document.querySelectorAll('.categoriaDesp')[i].value;
    if(v){
      csv += `Despesa;${d.value};${v};${c}\n`;
      totalDesp += parseFloat(v);
    }
  });
  let sobra = totalRend - totalDesp;
  csv += `;;;\nTotal;;${totalRend.toFixed(2)}€;Rendimentos\nTotal;;${totalDesp.toFixed(2)}€;Despesas\nDiferença;;${sobra.toFixed(2)}€;Sobra\n`;

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'orcamento.csv'; a.click();
  URL.revokeObjectURL(url);
}

// Export PDF funcional
function exportPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','mm','a4');
  let y = 10;

  // Título
  pdf.setFontSize(18);
  pdf.setTextColor(0, 119, 182);
  pdf.text('Resumo do Orçamento', 105, y, { align: 'center' });
  y += 15;

  // Resumo
  const resultado = document.getElementById('resultado').innerText;
  const linhas = resultado.split('\n').filter(line => 
    line.startsWith('Total') || line.startsWith('Sobra') || line.includes(':')
  );
  pdf.setFontSize(12);
  pdf.setTextColor(0,0,0);
  linhas.forEach(l => {
    pdf.text(l, 10, y);
    y += 7;
  });

  y += 10;

  // Gráfico
  const canvas = document.getElementById('grafico');
  const imgData = canvas.toDataURL('image/png');
  const pageWidth = pdf.internal.pageSize.getWidth();
  const imgProps = pdf.getImageProperties(imgData);
  const imgHeight = (imgProps.height * pageWidth) / imgProps.width;
  pdf.addImage(imgData, 'PNG', 0, y, pageWidth, imgHeight);

  pdf.save('orcamento_resumo.pdf');
}

// Inicializa campos
adicionarRendimento();
adicionarDespesa();
</script>

</body>
</html>
